<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>refactoring with singleton</title>
<meta name=description content="felladog"><meta name=author content="Utsav Darlami"><link rel="shortcut icon" href=/blogs/img/21-512.png><link rel=stylesheet href=/blogs/css/style.css><link rel=stylesheet href=/blogs/css/syntax.css><link rel=stylesheet href=/blogs/css/toc.css><link rel=stylesheet href=/blogs/katex/katex.min.css><script defer src=/blogs/katex/katex.min.js></script><script defer src=/blogs/katex/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script></head><body><header></header><main><div class=toc><nav id=TableOfContents><ul><li><a href=#previous-logic-in-my-project>Previous Logic in my project</a></li><li><a href=#implementing-singleton>Implementing Singleton</a></li><li><a href=#a-pitfall-to-be-aware-of>A pitfall to be aware of</a></li><li><a href=#p-dot-s>P.S</a></li></ul></nav><a href=# class=back-to-top>Back to top</a></div><script src=https://utsavdarlami.github.io/blogs/js/libs/jquery/3.3.1/jquery.slim.min.js></script><script>(function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var n,o=t.scrollTop(),i=$(".body h1, .body h2, .body h3, .body h4, .body h5, .body h6"),s="";if(i.each(function(e,t){t=$(t),t.offset().top-10<=o&&(s=t.attr("id"))}),n=e.find("a.current"),n.length==1&&n.eq(0).attr("href")=="#"+s)return!0;n.each(function(e,t){$(t).removeClass("current").siblings("ul").hide()}),e.find('a[href="#'+s+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").addClass("current").siblings("ul").show()})}t.on("scroll",n),$(document).ready(function(){e.find("a").parent("li").find("ul").hide(),n(),document.getElementsByClassName("toc")[0].style.display=""})}})()</script><p align=right><a href=https://utsavdarlami.github.io/blogs/about>me</a> |
<a href=https://utsavdarlami.github.io/blogs/>blogs</a> |
<a href=https://utsavdarlami.github.io/blogs/notes>notes</a> |
<a href=https://utsavdarlami.github.io/blogs/tags>tags</a> |
<a href=https://utsavdarlami.github.io/blogs/categories>categories</a> |
<a href=https://utsavdarlami.github.io/blogs/index.xml>feed</a> |
<a href=https://utsavdarlami.github.io/dlog/>dlog</a> |
<a href=https://utsavdarlami.github.io/>home</a> |</p><article><h1>refactoring with singleton</h1><div style=float:left><time>Created Date : 2024 May 21</time></div><br><div style=float:left><time>Last Modified : 2024 May 29</time></div><hr><div>tags:
<a href=/tags/python>python</a>
<a href=/tags/refactoring>refactoring</a></div><div style=float:left>categories:
<a href=/categories/python>python</a></div><div><hr><ul><li>References :<ol><li><a href=https://refactoring.guru/design-patterns/singleton>https://refactoring.guru/design-patterns/singleton</a></li><li><a href=https://python-patterns.guide/gang-of-four/singleton/>https://python-patterns.guide/gang-of-four/singleton/</a></li></ol></li><li>Questions :</li><li>Notes:</li></ul><hr><p>Welcome to tale of me writing a bad code and refactoring it with new learned knowledge to write not so bad code.</p><p>I was watching a conference video <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> on <a href=/blogs/404.html>metaclasses</a>, which introduced me to <a href=/blogs/404.html>singleton</a>. I realized that i could use this creational <a href=/blogs/404.html>design pattern</a> <a href=#org-target--r1>1.1</a> for one of my project.</p><h2 id=previous-logic-in-my-project>Previous Logic in my project</h2><p>There is a factory which processes list of <code>Box</code> object to form a final <code>Box</code>. Names have been changed for their privacy.</p><p>I had a state <code>ProcessState</code> keeping tracking of whole process and is attached to all the <code>Box</code> which are being processed in this Factory. <code>Box</code> dumps data in <code>ProcessState</code> which can later be used in preparing the final box. In simple terms <code>ProcessState</code> is a global variable on which different <code>Box</code> dump their data.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>field</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProcessState</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>box_type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>:</span> <span class=n>Dict</span> <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>box_count</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=n>ProcessState</span><span class=p>(</span><span class=n>box_type</span><span class=o>=</span><span class=s2>&#34;generic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ProcessState(box_type=&#39;generic&#39;, state={}, box_count=0, log=&#39;&#39;)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Box</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;white&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;flower&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ProcessState</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>box</span> <span class=o>=</span> <span class=n>Box</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>box</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Box(color=&#39;white&#39;, size=(0, 0), pattern=&#39;flower&#39;, state=None)
</span></span></code></pre></div><p>Creation of boxes</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>raw_boxes</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>Box</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>Box</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s1>&#39;pink&#39;</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;bird&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>Box</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;snake&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>Box</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s1>&#39;purple&#39;</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span> <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;dust&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>box</span> <span class=ow>in</span> <span class=n>raw_boxes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>box</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>state</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>box_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>boxes</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span></code></pre></div><p>On this list of boxes a list of processor would work on to create a final box. Each processor would have their own business logic which modifies the passed box or creates new box.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_snake_pattern</span><span class=p>(</span><span class=n>box</span><span class=p>:</span> <span class=n>Box</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Box</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    A business logic processor that modifies and creates a new box
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Removes snake patterns and replaces with default box attribute
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>box</span><span class=o>.</span><span class=n>pattern</span> <span class=o>==</span> <span class=s2>&#34;snake&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>new_box</span> <span class=o>=</span> <span class=n>Box</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>log</span> <span class=o>+=</span> <span class=s2>&#34;Cleaned snake pattern box</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>update</span><span class=p>({</span><span class=s1>&#39;snake&#39;</span><span class=p>:</span> <span class=s1>&#39;seen&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>box</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>new_box</span><span class=o>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>box</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>    <span class=n>new_box</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>box</span><span class=o>.</span><span class=n>state</span>  <span class=c1># make sure you sync up the state properly</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new_box</span>
</span></span><span class=line><span class=cl><span class=n>remove_snake_pattern</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;function remove_snake_pattern at 0x7fae4f2b6840&gt;
</span></span></code></pre></div><p>Now lets call this processor for our raw boxes</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>processors</span> <span class=o>=</span> <span class=p>[</span><span class=n>remove_snake_pattern</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>processed_box</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>box</span> <span class=ow>in</span> <span class=n>raw_boxes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;for box </span><span class=si>{</span><span class=n>box</span><span class=o>.</span><span class=n>pattern</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>processor</span> <span class=ow>in</span> <span class=n>processors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;State id before Process </span><span class=si>{</span><span class=nb>id</span><span class=p>(</span><span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>box</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>box</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;State id after Process </span><span class=si>{</span><span class=nb>id</span><span class=p>(</span><span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_box</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>box</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>for box flower
</span></span><span class=line><span class=cl>State id before Process 140386633097680
</span></span><span class=line><span class=cl>State id after Process 140386633097680
</span></span><span class=line><span class=cl>for box bird
</span></span><span class=line><span class=cl>State id before Process 140386633097680
</span></span><span class=line><span class=cl>State id after Process 140386633097680
</span></span><span class=line><span class=cl>for box snake
</span></span><span class=line><span class=cl>State id before Process 140386633097680
</span></span><span class=line><span class=cl>State id after Process 140386633097680
</span></span><span class=line><span class=cl>for box dust
</span></span><span class=line><span class=cl>State id before Process 140386633097680
</span></span><span class=line><span class=cl>State id after Process 140386633097680
</span></span><span class=line><span class=cl>ProcessState(box_type=&#39;generic&#39;, state={&#39;snake&#39;: &#39;seen&#39;}, box_count=4, log=&#39;Cleaned snake pattern box\n&#39;)
</span></span></code></pre></div><p>It was bugging me that i had to use an extra line to make sure that i attach or assign the <code>ProcessState</code> to all <code>Box</code> object explicitly. It felt redundant and required me to explicitly mention why it was done. In addition to that we need to make sure that the new document state object is not created and attached during the processing flow.</p><h2 id=implementing-singleton>Implementing Singleton</h2><p>To cure my above itch and reduce that extra work of making sure that i attach the state when moving from box to box or making sure that only a single <code>ProcessState</code> object is created i thought of introducing <code>Singleton</code> pattern to my code-base.</p><p>To implement the <a href=/blogs/404.html>singleton</a> pattern i took the reference from this <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> stackoverflow thread</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Singleton</span><span class=p>(</span><span class=nb>type</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    A metaclass that creates a Singleton base class when called.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Read more here:
</span></span></span><span class=line><span class=cl><span class=s2>    https://stackoverflow.com/questions/6760685/what-is-the-best-way-of-implementing-singleton-in-python
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Also, Destroying a Singleton object in Python
</span></span></span><span class=line><span class=cl><span class=s2>    https://stackoverflow.com/questions/43619748/destroying-a-singleton-object-in-python
</span></span></span><span class=line><span class=cl><span class=s2>    https://stackoverflow.com/questions/63985051/how-to-reset-a-singleton-instance-in-python-in-this-case
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_instances</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>cls</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_instances</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>instance</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>Singleton</span><span class=p>,</span> <span class=bp>cls</span><span class=p>)</span><span class=o>.</span><span class=fm>__call__</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>cls</span><span class=o>.</span><span class=n>_instances</span><span class=p>[</span><span class=bp>cls</span><span class=p>]</span> <span class=o>=</span> <span class=n>instance</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_instances</span><span class=p>[</span><span class=bp>cls</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>clear</span><span class=p>(</span><span class=bp>cls</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>cls</span><span class=o>.</span><span class=n>_instances</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProcessStateV2</span><span class=p>(</span><span class=n>metaclass</span><span class=o>=</span><span class=n>Singleton</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>box_type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>:</span> <span class=n>Dict</span> <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>box_count</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=n>ProcessStateV2</span><span class=p>(</span><span class=n>box_type</span><span class=o>=</span><span class=s2>&#34;generic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>id</span><span class=p>(</span><span class=n>state</span><span class=p>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ProcessStateV2(box_type=&#39;generic&#39;, state={}, box_count=0, log=&#39;&#39;)
</span></span><span class=line><span class=cl>140386634458256
</span></span></code></pre></div><p>Based on this new <code>ProcessState</code> class definition we need to slightly modify our definition of the <code>Box</code> class to truly utilize the singleton design pattern</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BoxV2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>color</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;white&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;flower&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>:</span> <span class=n>ProcessStateV2</span> <span class=o>=</span> <span class=n>ProcessStateV2</span><span class=p>(</span><span class=n>box_type</span><span class=o>=</span><span class=s2>&#34;generic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>box</span> <span class=o>=</span> <span class=n>BoxV2</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>box</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>id</span><span class=p>(</span><span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=p>))</span>
</span></span></code></pre></div><p>Why Initialize the ProcessState on the Box Object Initialization Now?</p><ul><li>It was done to utilize the singleton pattern. For now on, any <code>Box</code> object we create will only have a single <code>ProcesState</code> object to refer to.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>raw_boxes</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>BoxV2</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>BoxV2</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s1>&#39;pink&#39;</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;bird&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>BoxV2</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;snake&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>BoxV2</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s1>&#39;purple&#39;</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span> <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;dust&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>box</span> <span class=ow>in</span> <span class=n>raw_boxes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>box_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>id</span><span class=p>(</span><span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>boxes</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span></code></pre></div><p>Lets also refactor the processor to utilize new definition.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_snake_pattern_v2</span><span class=p>(</span><span class=n>box</span><span class=p>:</span> <span class=n>BoxV2</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>BoxV2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    A business logic processor that modifies and creates a new box
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Removes snake patterns and replaces with default box attribute
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>box</span><span class=o>.</span><span class=n>pattern</span> <span class=o>==</span> <span class=s2>&#34;snake&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>new_box</span> <span class=o>=</span> <span class=n>BoxV2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>new_box</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>log</span> <span class=o>+=</span> <span class=s2>&#34;Cleaned snake pattern box</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>new_box</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>update</span><span class=p>({</span><span class=s1>&#39;snake&#39;</span><span class=p>:</span> <span class=s1>&#39;seen&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>box</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>new_box</span><span class=o>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>box</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new_box</span>
</span></span><span class=line><span class=cl><span class=n>remove_snake_pattern_v2</span>
</span></span></code></pre></div><p>In this refactored function we can see that we have removed the explicit assignment of `state` to the new <code>Box</code> object. Now a dev can focus on the business logic and won&rsquo;t have to remember to preserve the state or copy the state before modifying it. Here <code>ProcessState</code> flows through the boxes as a global variable.</p><p>Now lets call this refactor processor for our raw boxes</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>processors</span> <span class=o>=</span> <span class=p>[</span><span class=n>remove_snake_pattern_v2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>processed_box</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>box</span> <span class=ow>in</span> <span class=n>raw_boxes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;for box </span><span class=si>{</span><span class=n>box</span><span class=o>.</span><span class=n>pattern</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>processor</span> <span class=ow>in</span> <span class=n>processors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;State id before Process </span><span class=si>{</span><span class=nb>id</span><span class=p>(</span><span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>box</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>box</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;State id after Process </span><span class=si>{</span><span class=nb>id</span><span class=p>(</span><span class=n>box</span><span class=o>.</span><span class=n>state</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_box</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>box</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span></code></pre></div><p>And Done. This is how applied <a href=/blogs/404.html>singleton</a> to refactor for my project.</p><h2 id=a-pitfall-to-be-aware-of>A pitfall to be aware of</h2><p>Be aware that the Singleton pattern will restrict the <code>ProcessState</code> class to have only a single object. When such an object is used in an API request, we need to ensure that it is cleaned or deleted after the request; otherwise, the same object will be reused.</p><p>How did I handle it in my API?</p><p>We implemented a method that clears out the class instance(s) created, i.e., <code>ProcessStateV2.clear()</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ProcessStateV2</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=n>ProcessStateV2</span><span class=p>(</span><span class=n>box_type</span><span class=o>=</span><span class=s2>&#34;generic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>state</span><span class=o>.</span><span class=n>log</span> <span class=o>+=</span> <span class=s2>&#34;new state created&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>id</span><span class=p>(</span><span class=n>state</span><span class=p>)</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>state</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>state2</span> <span class=o>=</span> <span class=n>ProcessStateV2</span><span class=p>(</span><span class=n>box_type</span><span class=o>=</span><span class=s2>&#34;new_generic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>id</span><span class=p>(</span><span class=n>state2</span><span class=p>)</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>state2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ProcessStateV2</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>state3</span> <span class=o>=</span> <span class=n>ProcessStateV2</span><span class=p>(</span><span class=n>box_type</span><span class=o>=</span><span class=s2>&#34;cleaned&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>id</span><span class=p>(</span><span class=n>state3</span><span class=p>)</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>state3</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ProcessStateV2</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>140386629460816 - ProcessStateV2(box_type=&#39;generic&#39;, state={}, box_count=0, log=&#39;new state created&#39;)
</span></span><span class=line><span class=cl>140386629460816 - ProcessStateV2(box_type=&#39;generic&#39;, state={}, box_count=0, log=&#39;new state created&#39;)
</span></span><span class=line><span class=cl>140386629256528 - ProcessStateV2(box_type=&#39;cleaned&#39;, state={}, box_count=0, log=&#39;&#39;)
</span></span></code></pre></div><h2 id=p-dot-s>P.S</h2><ul><li>Do go through <sup id=fnref1:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> and <a href=#org-target--r2>1.2</a></li><li>There might be better way to handle this of-course but as of now i could only think of this solution</li></ul><p>All this changes resulted in adding more lines of code then removing (refactoring i guess).</p><figure><img src=/blogs/ox-hugo/2024-05-23_16-20-22_screenshot.png alt="Figure 1: Post refactoring changes" width=800 height=200><figcaption><p>Figure 1: Post refactoring changes</p></figcaption></figure><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href="https://www.youtube.com/watch?v=-js0K7Q878c">&ldquo;Metaprogramming in Python using Metaclasses&rdquo; - Adarsh Divakaran (PyCascades 2023)</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://stackoverflow.com/questions/6760685/what-is-the-best-way-of-implementing-singleton-in-python>what-is-the-best-way-of-implementing-singleton-in-python</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><p style=font-size:1.65em;text-align:center><a href=/blogs/posts/20230829193605-image_binarization_and_pixel_count/>&#8678;</a></p><hr><hr><footer><main><h3>Comments</h3><script src=https://utteranc.es/client.js repo=utsavdarlami/blogs issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></main></footer></article></main><footer></footer></body></html>